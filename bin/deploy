#!/bin/bash
set -euo pipefail

export VERSION=`git describe | cut -c2-`

if ! docker secret inspect landscapes_secret_key_base &>/dev/null
then
  docker run --rm wearepal/landscapes:$VERSION bin/rails secret | docker secret create landscapes_secret_key_base - &>/dev/null
fi

if ! docker config inspect landscapes_caddyfile &>/dev/null
then
  read -p "Enter your domain name, e.g. landscapes.your-university.ac.uk [localhost]: " ADDRESS
  export ADDRESS="${ADDRESS:-localhost}"
  envsubst < Caddyfile | docker config create landscapes_caddyfile - &>/dev/null
fi

if ! docker secret inspect landscapes_storage &>/dev/null
then
  cp "config/storage.yml" "tmp/storage.yml"
  "${EDITOR:-vi}" "tmp/storage.yml"
  docker secret create landscapes_storage "tmp/storage.yml" &>/dev/null
fi

envsubst < "docker-compose.yml" | docker stack deploy "landscapes" -c -
